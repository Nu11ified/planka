services:
  planka-server:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: planka-dev
    pull_policy: never
    command: ["bash", "-c", "npm install && npm run db:init && npm start"]
    restart: on-failure
    volumes:
      - ./server:/app
    ports:
      - "1337:1337"

    environment:
      # Core
      BASE_URL: ${BASE_URL}
      DATABASE_URL: ${DATABASE_URL}
      SECRET_KEY: ${SECRET_KEY}

      # Logging / runtime
      NODE_ENV: development
      LOG_LEVEL: warn
      TRUST_PROXY: "true"

      # Auth / tokens
      TOKEN_EXPIRES_IN: "365"

      # PostgreSQL / Knex SSL handling
      PGSSLMODE: ${PGSSLMODE:-disable}
      KNEX_REJECT_UNAUTHORIZED_SSL_CERTIFICATE: "false"

      # Language
      DEFAULT_LANGUAGE: en-US

      # Default admin bootstrap (created on first run only)
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD}
      DEFAULT_ADMIN_NAME: ${DEFAULT_ADMIN_NAME}
      DEFAULT_ADMIN_USERNAME: ${DEFAULT_ADMIN_USERNAME}

      # Limits (optional)
      STORAGE_LIMIT: ${STORAGE_LIMIT:-}
      ACTIVE_USERS_LIMIT: ${ACTIVE_USERS_LIMIT:-}

      # SMTP (email notifications)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_NAME: ${SMTP_NAME}
      SMTP_SECURE: ${SMTP_SECURE:-true}
      SMTP_TLS_REJECT_UNAUTHORIZED: ${SMTP_TLS_REJECT_UNAUTHORIZED:-false}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      # SMTP_FROM: ${SMTP_FROM}

      # Privacy
      # GRAVATAR_BASE_URL: ${GRAVATAR_BASE_URL:-}

  planka-client:
    image: planka-dev
    pull_policy: never
    command: ["bash", "-c", "npm install && npx vite --host"]
    restart: on-failure
    volumes:
      - ./client:/app
    ports:
      - 3011:3000

volumes:
  db-data:
